import { z } from 'zod';

// Question option schema
export const QuestionOptionSchema = z.object({
  label: z.string(),
  description: z.string(),
});

export type QuestionOption = z.infer<typeof QuestionOptionSchema>;

// Plan question schema
export const PlanQuestionSchema = z.object({
  index: z.number(),
  question: z.string(),
  header: z.string(),
  options: z.array(QuestionOptionSchema),
  multi_select: z.boolean(),
  tool_use_id: z.string(),
});

export type PlanQuestion = z.infer<typeof PlanQuestionSchema>;

// Plan answer schema
export const PlanAnswerSchema = z.object({
  question_index: z.number(),
  answers: z.array(z.string()),
});

export type PlanAnswer = z.infer<typeof PlanAnswerSchema>;

// Plan status enum
export const PlanStatusSchema = z.enum([
  'questioning',
  'summary',
  'completed',
  'cancelled',
  'error',
]);

export type PlanStatus = z.infer<typeof PlanStatusSchema>;

// Plan session info (what the API returns)
export const PlanSessionInfoSchema = z.object({
  id: z.string(),
  title: z.string(),
  prompt: z.string(),
  questions: z.array(PlanQuestionSchema),
  answers: z.array(PlanAnswerSchema),
  status: PlanStatusSchema,
  summary: z.string().nullable(),
  ask_questions: z.boolean(),
});

export type PlanSessionInfo = z.infer<typeof PlanSessionInfoSchema>;

// API request/response types
export interface StartPlanRequest {
  title: string;
  prompt: string;
  session_id: string;  // Generated by frontend to avoid race condition
  /** Whether Claude should ask clarifying questions (uses PLAN_MODE_SUFFIX) */
  ask_questions?: boolean;
}

export interface StartPlanResponse {
  session_id: string;
}

export interface SingleAnswerRequest {
  question_index: number;
  answers: string[];
}

export interface AnswerRequest {
  answers: SingleAnswerRequest[];
}

export interface ExecutePlanRequest {
  title: string;
  description?: string;
}

export interface ExecutePlanResponse {
  task_id: string;
  message: string;
}

// UI state for Plan Mode
export type PlanPhase = 'idle' | 'questioning' | 'summary' | 'executing' | 'error';

export interface PlanModeState {
  phase: PlanPhase;
  sessionId: string | null;
  /** All questions in current batch (1-4 questions from AskUserQuestion) */
  currentQuestions: PlanQuestion[];
  /** Index of the active tab/question being answered */
  activeQuestionIndex: number;
  /** User's answers: question index -> selected answers */
  pendingAnswers: Record<number, string[]>;
  /** Total questions answered across all batches */
  questionCount: number;
  isLoading: boolean;
  summary: string | null;
  error: string | null;
}
